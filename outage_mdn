SELECT MAX(OUTAGE_ID) OUTAGE_ID,
       MAX(NSR_DATE) OUTAGE_DATE_HOUR,
       NSR_DAY OUTAGE_DAY,
       SUBSTR(MAX(NSR_DATE),9) OUTAGE_HOUR,
       MAX(START_TIME) OUTAGE_START_TIME,
       '' ENODEBID,
       EMIN,
       MAX(MDN) MDN,
       SUM(CONNECT_ATTEMPTS) CUMM_SUCCESS_CONNECTS,
       COUNT(1) NUM_WEEKS,
       '${hiveconf:CURRENT_LOADTIME}' LOAD_TIME,
       MAX(CITY) CITY,
       MAX(STATE) STATE,
       MAX(NEXT_15MIN_OUTAGE_TIME) NEXT_15MIN_OUTAGE_TIME,
       MAX(NSR_DATE) OUTAGE_DATE
 FROM (SELECT IOM.MDN,NSR.*,IO.* 
         FROM (SELECT DISTINCT OUTAGE_ID, MDN FROM ${hiveconf:DATABASE_NAME}.STP_IVR_OUTAGE_MDN) IOM
       INNER JOIN
              (SELECT OUTAGE_ID,MAX(START_TIME) START_TIME,CAST(MAX(OUTAGE_START_DATE_HOUR) AS BIGINT) NSR_START_HOUR,MAX(CITY) CITY,MAX(STATE) STATE,MAX(NEXT_15MIN_OUTAGE_TIME) NEXT_15MIN_OUTAGE_TIME   
                FROM ${hiveconf:DATABASE_NAME}.STP_OUTAGE_MEDIATION_LOG
               WHERE OUTAGE_ID=${hiveconf:OUTAGEID} GROUP BY OUTAGE_ID
              ) IO ON IO.OUTAGE_ID=IOM.OUTAGE_ID
       INNER JOIN
              ${hiveconf:DATABASE_NAME}.NSR_GEOSPATIAL_HOURLY_AGG NSR
          ON  NSR.NSR_DATE=NSR_START_HOUR
         AND  IOM.MDN=NSR.MTN
       UNION ALL
              SELECT IOM.MDN,NSR.*,IO.* FROM (SELECT DISTINCT OUTAGE_ID, MDN FROM ${hiveconf:DATABASE_NAME}.STP_IVR_OUTAGE_MDN) IOM
       INNER JOIN
              (
              SELECT OUTAGE_ID,MAX(START_TIME) START_TIME,CAST(MAX(OUTAGE_START_DATE_HOUR_WEEK1) AS BIGINT) NSR_DATE_WEEK1,MAX(CITY) CITY,MAX(STATE) STATE,MAX(NEXT_15MIN_OUTAGE_TIME) NEXT_15MIN_OUTAGE_TIME FROM ${hiveconf:DATABASE_NAME}.STP_OUTAGE_MEDIATION_LOG WHERE OUTAGE_ID=${hiveconf:OUTAGEID} GROUP BY OUTAGE_ID
              ) IO ON IO.OUTAGE_ID=IOM.OUTAGE_ID
       INNER JOIN
              ${hiveconf:DATABASE_NAME}.NSR_GEOSPATIAL_HOURLY_AGG NSR
         ON   NSR.NSR_DATE=NSR_DATE_WEEK1
         AND  IOM.MDN=SUBSTR(NSR.CELLTOWER,2)
       UNION ALL
             SELECT IOM.MDN,NSR.*,IO.* FROM (SELECT DISTINCT OUTAGE_ID, MDN FROM ${hiveconf:DATABASE_NAME}.STP_IVR_OUTAGE_MDN) IOM
       INNER JOIN
              (
              SELECT OUTAGE_ID,MAX(START_TIME) START_TIME,CAST(MAX(OUTAGE_START_DATE_HOUR_WEEK2) AS BIGINT) NSR_DATE_WEEK2,MAX(CITY) CITY ,MAX(STATE) STATE,MAX(NEXT_15MIN_OUTAGE_TIME) NEXT_15MIN_OUTAGE_TIME  FROM ${hiveconf:DATABASE_NAME}.STP_OUTAGE_MEDIATION_LOG WHERE OUTAGE_ID=${hiveconf:OUTAGEID} GROUP BY OUTAGE_ID
              ) IO ON IO.OUTAGE_ID=IOM.OUTAGE_ID
       INNER JOIN
             ${hiveconf:DATABASE_NAME}.NSR_GEOSPATIAL_HOURLY_AGG NSR
         ON  NSR.NSR_DATE=NSR_DATE_WEEK2
        AND  IOM.MDN=SUBSTR(NSR.CELLTOWER,2)
       UNION ALL
             SELECT IOM.MDN,NSR.*,IO.* FROM (SELECT DISTINCT OUTAGE_ID, MDN FROM ${hiveconf:DATABASE_NAME}.STP_IVR_OUTAGE_MDN) IOM
       INNER JOIN
             (
             SELECT OUTAGE_ID,MAX(START_TIME) START_TIME,CAST(MAX(OUTAGE_START_DATE_HOUR_WEEK3) AS BIGINT) NSR_DATE_WEEK3,MAX(CITY) CITY,MAX(STATE) STATE,MAX(NEXT_15MIN_OUTAGE_TIME) NEXT_15MIN_OUTAGE_TIME FROM ${hiveconf:DATABASE_NAME}.STP_OUTAGE_MEDIATION_LOG WHERE OUTAGE_ID=${hiveconf:OUTAGEID} GROUP BY OUTAGE_ID
             ) IO ON IO.OUTAGE_ID=IOM.OUTAGE_ID
       INNER JOIN
             ${hiveconf:DATABASE_NAME}.NSR_GEOSPATIAL_HOURLY_AGG NSR
         ON  NSR.NSR_DATE=NSR_DATE_WEEK3
        AND  IOM.MDN=SUBSTR(NSR.CELLTOWER,2)
       UNION ALL
             SELECT IOM.MDN,NSR.*,IO.* FROM (SELECT DISTINCT OUTAGE_ID, MDN FROM ${hiveconf:DATABASE_NAME}.STP_IVR_OUTAGE_MDN) IOM
       INNER JOIN
             (
             SELECT OUTAGE_ID,MAX(START_TIME) START_TIME,CAST(MAX(OUTAGE_START_DATE_HOUR_WEEK4) AS BIGINT) NSR_DATE_WEEK4,MAX(CITY) CITY,MAX(STATE) STATE ,MAX(NEXT_15MIN_OUTAGE_TIME) NEXT_15MIN_OUTAGE_TIME FROM ${hiveconf:DATABASE_NAME}.STP_OUTAGE_MEDIATION_LOG WHERE OUTAGE_ID=${hiveconf:OUTAGEID} GROUP BY OUTAGE_ID
             ) IO ON IO.OUTAGE_ID=IOM.OUTAGE_ID
       INNER JOIN
             ${hiveconf:DATABASE_NAME}.NSR_GEOSPATIAL_HOURLY_AGG NSR
         ON  NSR.NSR_DATE=NSR_DATE_WEEK4
        AND  IOM.MDN=SUBSTR(NSR.CELLTOWER,2)
      ) A 
 GROUP BY MDN,EMIN,NSR_DAY;
